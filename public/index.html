<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/web-component@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>
  <title>Calendario de Salas</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="calendar"></div>
  <!-- Modal para mostrar detalles del evento -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Detalles del Evento</h2>
      <p><strong>Inicio:</strong> <span id="modalStart"></span></p>
      <p><strong>Fin:</strong> <span id="modalEnd"></span></p>
      <p><strong>Nombre Evento:</strong> <span id="modalDescription"></span></p>
      <p><strong>Ubicaci칩n:</strong> <span id="modalLocation"></span></p>
      <p><strong>Requerimientos:</strong> <span id="modalRequirements"></span></p>
    </div>
  </div>

  <script src="ics-parser.js"></script>
  <script>
    let calendar;
    const icsUrls = {
      /*"FHGCP LABORATORIO HISTORIA DIGITAL (BLOQUEADA)":
    "http://outlook.office365.com/owa/calendar/0f52822f5d1443ca9da46abe398d3cad@uc.cl/bd3e7f72cc844f38a9cc0d517cd0660616195049527368204434/calendar.ics",*/
      "FHGCP DECANATO AUDITORIO 游녻126":
        "http://outlook.office365.com/owa/calendar/e857cbdab6ea47749bc06e0adc9dbb73@uc.cl/05c7b41e95694645bfda2c3b084ade8014595092356990759330/calendar.ics",
      "FHGCP DECANATO SALA CONSEJO FACULTAD 游녻25":
        "http://outlook.office365.com/owa/calendar/f03c42313f964c819b4aecd10a62f81f@uc.cl/46e74d9c80a945e384f3971b525ea76e11052745610678742020/calendar.ics",
      "FHGCP DECANATO SALA REUNIONES 游녻10":
        "http://outlook.office365.com/owa/calendar/0d1da151aef7420190fb315b6d4dfadc@uc.cl/7317cf9f67ea4dd8b91c5daa82d595867171139558961955839/calendar.ics",
      "FHGCP LABORATORIO DE GEOMATICA 游녻14":
        "http://outlook.office365.com/owa/calendar/046148a2e92a42f9a6b2d31973ec711f@uc.cl/b8812806946548e79cc1ccdda6926e3c9063704853347367516/calendar.ics",
      /*"FHGCP SALA ATACAMA (BLOQUEADA)":
    "http://outlook.office365.com/owa/calendar/b5117cef0ec94991a099c3561b707736@uc.cl/1db1373dffb64e47a946c80071e8e38d5796220034483856327/calendar.ics",*/
      "FHGCP SALA CONSEJO CIENCIA POLITICA 游녻12":
        "http://outlook.office365.com/owa/calendar/bd828681f6ba4d2aa117aafc856c98f9@uc.cl/bce644202ac3415e9ef3d79469981e4f15364390778314373260/calendar.ics",
      "FHGCP SALA CONSEJO GEOGRAFIA 游녻8":
        "http://outlook.office365.com/owa/calendar/4b0b3a0a1fc6489b87524b9b7ed9c687@uc.cl/8d66e4c06f5e4b4692af362963a98da03628685577008031525/calendar.ics",
      "FHGCP SALA CONSEJO HISTORIA 游녻12":
        "http://outlook.office365.com/owa/calendar/ec65ead6c8564a17ac3ea480542fe5fa@uc.cl/0318f94758864b32a68ac0567319535b8003472245692917270/calendar.ics",
      "FHGCP SALA DOCTORADO CIENCIA POLITICA 游녻12":
        "http://outlook.office365.com/owa/calendar/22c286212fae46b994a3ce3a8de2065c@uc.cl/a5bcf5a0d1a44f138c0ebcf10e01b75d5615022796294095401/calendar.ics",
      "FHGCP SALA DOCTORADO GEOGRAFIA 游녻10":
        "http://outlook.office365.com/owa/calendar/0253785e99494b18859b3cd9020aa93a@uc.cl/643ef88f85324b359beb359e913e26c66644004865990384362/calendar.ics",
      "FHGCP SALA HUMANIDADES 1 游녻4":
        "http://outlook.office365.com/owa/calendar/235b2e37013147b0999557e26748d96b@uc.cl/c8e962a0d7d4479d81ae6fa110f8f65a16714046150349654577/calendar.ics",
      "FHGCP SALA HUMANIDADES 2 游녻4":
        "http://outlook.office365.com/owa/calendar/598fea8e95f543ba8b521b49fc384ba2@uc.cl/4ca8de726ca9473190872a6735eb84a616695268912745945723/calendar.ics",
      "FHGCP SALA HUMANIDADES 3 游녻4":
        "http://outlook.office365.com/owa/calendar/854f687d101745b481c3892f5ff6f2d1@uc.cl/38f78a1f13d1434e8eb91d645dd4547810658958581129542550/calendar.ics",
      "FHGCP SALA HUMANIDADES 4 游녻4":
        "http://outlook.office365.com/owa/calendar/bc6e41c921704d3293d6ddcc403062cc@uc.cl/64b37ec71d7148859fc10832f63b219c1386908969546599371/calendar.ics",
      "FHGCP SALA POSTGRADO HISTORIA 游녻10":
        "http://outlook.office365.com/owa/calendar/266599e201af412ea7dae37017d005d9@uc.cl/192bfa5db8de4aa2ac7349d5f0c8b18715751757247432996149/calendar.ics",
      "FHGCP SALA REUNIONES A 7 游녻10":
        "http://outlook.office365.com/owa/calendar/e02e143a5a9046a09b1a3617d9ce77a1@uc.cl/d3162863aa504a359b72db03c50a1b6110851382597755342633/calendar.ics",
      "FHGCP SALA USOS MULTIPLES 游녻22":
        "http://outlook.office365.com/owa/calendar/00a05e5068504048b8219caa353bb694@uc.cl/e30ae1041cf641ae91784c7b661367306773761822066238338/calendar.ics",
      "FHGCP SEMINARIO 1 游녻20":
        "http://outlook.office365.com/owa/calendar/f629bb8381d74e0d983c7b3a7046bd9d@uc.cl/7c7ff6bd15b145feb486c1038123e85b9030138489073154610/calendar.ics",
      "FHGCP SEMINARIO 3 游녻20":
        "http://outlook.office365.com/owa/calendar/784fbbe196e6488fa3ccf1188110b51d@uc.cl/843b2e2da6bd44a3bf3ebaa4fc1261378700988533943244368/calendar.ics",
      "FHGCP SEMINARIO 4 游녻14":
        "http://outlook.office365.com/owa/calendar/36640d39764643ec9478ecabeaf12fac@uc.cl/60ef724d838749ebbd1508696831d3e03505045718671364020/calendar.ics",
      "FHGCP SEMINARIO 5 游녻14":
        "http://outlook.office365.com/owa/calendar/fb1053ad62dc4080a7dae63e4e611066@uc.cl/bc7ee4f56c4d4f269b9ec65fa5f4a57a15500861614651285450/calendar.ics",
      "FHGCP SEMINARIO 6 游녻10":
        "http://outlook.office365.com/owa/calendar/09429815e1a34cc0bb43e98250bbf0c6@uc.cl/907f486c650149fa91869781aadefaeb4501534105365124751/calendar.ics",
      "FHGCP SEMINARIO FACULTAD 游녻41":
        "http://outlook.office365.com/owa/calendar/cb9d40caf77c43629fdb9f7cb9249afb@uc.cl/2f99deb939944c9a9de027ccc2e821497528731868425315838/calendar.ics",
      "FHGCP TERRAZA 游녻50":
        "http://outlook.office365.com/owa/calendar/3033c0791e414b4fa60cc29a059e4037@uc.cl/988ff7fb55c14d42b29b01c0860b7c0e3542970083574507192/calendar.ics",
      /*"FHGCP SALA PATAGONIA (BLOQUEADA)":
    "http://outlook.office365.com/owa/calendar/b32f2d9add9849fdb80f435fccfda899@uc.cl/ab223c3d83b7461fa7ad0da90adb50771180359976278031607/calendar.ics",*/
    };


    const reservationLinks = {
      "FHGCP_SALA_REUNIONES_A_7_游녻10":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-A-7@uc.cl&location=FHGCP-A-7@uc.cl",
      "FHGCP_DECANATO_AUDITORIO_游녻126":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DECANATO-AUDITORIO@uc.cl&location=FHGCP-DECANATO-AUDITORIO@uc.cl&body=Elimina%20este%20mensaje,%20por%20favor%20seleccione%20SOLO%20el%20equipamiento%20que%20necesita%20para%20la%20actividad.<br>Servicios%20incluidos:<br>2%20micr%C3%B3fonos%20inal%C3%A1mbricos<br>1%20micr%C3%B3fono%20de%20solapa<br>4%20micr%C3%B3fonos%20fijos%20cuello%20de%20ganso<br>1%20notebook<br>1%20computador%20fijo%20en%20sala%20de%20audio<br>3%20testeras<br>1%20mesa%20de%20vidrio<br>4%20sillones%20de%20felpa%20gris<br>6%20sillas%20con%20ruedas%20de%20felpa%20gris<br>1%20podio%20de%20madera<br>5%20tarjeteros%20para%20nombre%20de%20invitados<br>2%20pantallas%20en%20la%20sala%20de%20audio<br>1%20ups%20de%20respaldo%20para%20la%20energ%C3%ADa<br>1%20sala%20de%20estar",
      "FHGCP_DECANATO_SALA_CONSEJO_FACULTAD_游녻25":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DECANATO-SALA-CONSEJO-FACULTAD@uc.cl&location=FHGCP-DECANATO-SALA-CONSEJO-FACULTAD@uc.cl",
      "FHGCP_DECANATO_SALA_REUNIONES_游녻10":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DECANATO-SALA-REUNIONES@uc.cl&location=FHGCP-DECANATO-SALA-REUNIONES@uc.cl",
      "FHGCP_SALA_DOCTORADO_GEOGRAFIA_游녻10":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DOCTORADO-GEOGRAFIA@uc.cl&location=FHGCP-DOCTORADO-GEOGRAFIA@uc.cl",
      "FHGCP_SALA_DOCTORADO_CIENCIA_POLITICA_游녻12":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DOCTORADO-ICP@uc.cl&location=FHGCP-DOCTORADO-ICP@uc.cl",
      FHGCP_DOCTORADO_ICP_2:
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DOCTORADO-ICP-2@uc.cl&location=FHGCP-DOCTORADO-ICP-2@uc.cl",
      "FHGCP_SALA_HUMANIDADES_1_游녻4":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-1@uc.cl&location=FHGCP-HUMANIDADES-1@uc.cl",
      "FHGCP_SALA_HUMANIDADES_2_游녻4":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-2@uc.cl&location=FHGCP-HUMANIDADES-2@uc.cl",
      "FHGCP_SALA_HUMANIDADES_3_游녻4":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-3@uc.cl&location=FHGCP-HUMANIDADES-3@uc.cl",
      "FHGCP_SALA_HUMANIDADES_4_游녻4":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-4@uc.cl&location=FHGCP-HUMANIDADES-4@uc.cl",
      "FHGCP_LABORATORIO_DE_GEOMATICA_游녻14":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-LABORATORIO-DE-GEOMATICA@uc.cl&location=FHGCP-LABORATORIO-DE-GEOMATICA@uc.cl",
      FHGCP_LABORATORIO_HISTORIA_DIGITAL:
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-LABORATORIO-HISTORIA-DIGITAL@uc.cl&location=FHGCP-LABORATORIO-HISTORIA-DIGITAL@uc.cl",
      FHGCP_SALA_ATACAMA:
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-ATACAMA@uc.cl&location=FHGCP-SALA-ATACAMA@uc.cl",
      "FHGCP_SALA_CONSEJO_HISTORIA_游녻12":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-CONSEJO-HISTORIA@uc.cl&location=FHGCP-SALA-CONSEJO-HISTORIA@uc.cl",
      "FHGCP_SALA_CONSEJO_CIENCIA_POLITICA_游녻12":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-CONSEJO-ICP@uc.cl&location=FHGCP-SALA-CONSEJO-ICP@uc.cl",
      "FHGCP_SALA_CONSEJO_GEOGRAFIA_游녻8":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-DE-CONSEJO-INSTITUTO-DE-GEOGRAFIA@uc.cl&location=FHGCP-SALA-DE-CONSEJO-INSTITUTO-DE-GEOGRAFIA@uc.cl",
      FHGCP_SALA_PATAGONIA:
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-PATAGONIA@uc.cl&location=FHGCP-SALA-PATAGONIA@uc.cl",
      "FHGCP_SALA_POSTGRADO_HISTORIA_游녻10":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-SEMINARIO-HISTORIA@uc.cl&location=FHGCP-SALA-SEMINARIO-HISTORIA@uc.cl",
      "FHGCP_SALA_USOS_MULTIPLES_游녻22":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-USOS-MULTIPLES@uc.cl&location=FHGCP-SALA-USOS-MULTIPLES@uc.cl&body=Elimina%20este%20mensaje,%20por%20favor%20seleccione%20SOLO%20el%20equipamiento%20que%20necesita%20para%20la%20actividad.<br>Servicios%20incluidos:<br>40%20sillas%20de%20metal%20con%20tela<br>8%20mesas<br>1%20data%20empotrado<br>1%20tel%C3%B3n<br>1%20tv%20con%20soporte%20movible<br>aire%20acondicionado",
      "FHGCP_SEMINARIO_1_游녻20":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO1@uc.cl&location=FHGCP-SEMINARIO1@uc.cl",
      "FHGCP_SEMINARIO_3_游녻20":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-3@uc.cl&location=FHGCP-SEMINARIO-3@uc.cl",
      "FHGCP_SEMINARIO_4_游녻14":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-4@uc.cl&location=FHGCP-SEMINARIO-4@uc.cl",
      "FHGCP_SEMINARIO_5_游녻14":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-5@uc.cl&location=FHGCP-SEMINARIO-5@uc.cl",
      "FHGCP_SEMINARIO_6_游녻10":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-6@uc.cl&location=FHGCP-SEMINARIO-6@uc.cl",
      "FHGCP_SEMINARIO_FACULTAD_游녻41":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-FACULTAD@uc.cl&location=FHGCP-SEMINARIO-FACULTAD@uc.cl&body=Elimina%20este%20mensaje,%20por%20favor%20seleccione%20SOLO%20el%20equipamiento%20que%20necesita%20para%20la%20actividad.<br>Servicios%20incluidos:<br>3%20mesas%20para%20profesor<br>40%20sillas%20con%20posa%20brazos<br>1%20data%20empotrado%20al%20techo<br>1%20tel%C3%B3n<br>1%20mueble%20para%20caf%C3%A9<br>1%20aire%20acondicionado",
      "FHGCP_SIMULACION_ICP_游녻50":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SIMULACION-ICP@uc.cl&location=FHGCP-SIMULACION-ICP@uc.cl",
      "FHGCP_TERRAZA_游녻50":
        "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-TERRAZA@uc.cl&location=FHGCP-TERRAZA@uc.cl",
    };

    document.addEventListener("DOMContentLoaded", function () {
      const calendarEl = document.getElementById("calendar");
      const modal = document.getElementById("eventModal");
      const modalClose = document.querySelector(".close");

      function isMobileDevice() {
        return /Mobi|Android/i.test(navigator.userAgent);
      }

      let headerToolbar, footerToolbar;

      if (isMobileDevice()) {
        headerToolbar = {
          left: "dayGridMonth,dayGridWeek,dayGridDay",
          center: "",
          right: "",
        };
        footerToolbar = {
          left: "title",
          center: "prev,today,next",
          right: "",
        };
      } else {
        headerToolbar = {
          left: "dayGridMonth,dayGridWeek,dayGridDay",
          center: "title,prev,today,next",
          right: "",
        };
        footerToolbar = {
          left: "",
          center: "",
          right: "",
        };
      }

      calendar = new FullCalendar.Calendar(calendarEl, {
        firstDay: 1,
        initialView: "dayGridMonth",
        locale: "es",
        headerToolbar: headerToolbar,
        footerToolbar: footerToolbar,
        buttonText: {
          today: "Hoy",
          month: "Mes",
          week: "Sem",
          day: "D칤a",
        },
        eventClick: function (info) {
          // Mostrar el modal con la informaci칩n del evento
          document.getElementById("modalTitle").textContent = info.event.title;
          document.getElementById("modalStart").textContent = info.event.start.toLocaleString("es-ES", {
            dateStyle: "full",
            timeStyle: "short",
          });
          document.getElementById("modalEnd").textContent = info.event.end
            ? info.event.end.toLocaleString("es-ES", { dateStyle: "full", timeStyle: "short" })
            : "N/A";
          document.getElementById("modalDescription").textContent = info.event.extendedProps.description || "Sin descripci칩n";
          document.getElementById("modalLocation").textContent = info.event.extendedProps.location || "Sin ubicaci칩n";
          document.getElementById("modalRequirements").textContent = info.event.extendedProps.requerimientos || "Sin requerimientos";

          modal.style.display = "block"; // Mostrar el modal
        },
        eventContent: function (arg) {
          const date = arg.event.start;
          const dateEnd = arg.event.end;

          // Verificar si la hora de inicio es a las 00:00
          const isAllDay = date.getHours() === 0 && date.getMinutes() === 0;

          // Si es "Todo el d칤a", mostrar como tal
          const formattedTime = isAllDay ? "Todo el d칤a" : date.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
          const formattedTimeEnd = isAllDay ? "Todo el d칤a" : dateEnd.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });

          return {
            html: `<div style="color: black; font-weight: normal;">${formattedTime} - ${formattedTimeEnd}<br>${arg.event.title}</div>`,
          };
        },
      });

      calendar.render();

      const toolbar = document.querySelector(".fc-toolbar-chunk:nth-child(3)");

      const select = document.createElement("select");
      select.id = "calendarSelector";
      const texto = document.createElement("span");
      texto.id = "textCampo";
      texto.textContent = "Sala:";

      const reservationButton = document.createElement("button");
      reservationButton.id = "reservationButton";
      reservationButton.textContent = "RESERVA";
      reservationButton.onclick = function () {
        const selectedCalendar = select.value;
        const formattedCalendar = selectedCalendar.replace(/ /g, "_").toUpperCase();

        if (reservationLinks[formattedCalendar]) {
          window.open(reservationLinks[formattedCalendar], "_blank");
        } else {
          console.log("No se encontr칩 un enlace de reserva para el calendario seleccionado.");
        }
      };

      select.addEventListener("change", function () {
        const selectedCalendar = select.value;
        if (selectedCalendar) {
          loadICS(selectedCalendar);
        }
      });

      Object.keys(icsUrls).forEach((calendarName) => {
        const option = document.createElement("option");
        option.value = calendarName;
        option.textContent = calendarName.replace(/_/g, " ");
        select.appendChild(option);
      });

      toolbar.appendChild(texto);
      toolbar.appendChild(select);
      toolbar.appendChild(reservationButton);

      loadICS(Object.keys(icsUrls)[0]);

      // Cerrar el modal al hacer clic en la "X"
      modalClose.onclick = function () {
        modal.style.display = "none";
      };

      // Cerrar el modal al hacer clic fuera de 칠l
      window.onclick = function (event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };
    });

    function loadICS(roomName) {
      fetch(`/ics/${roomName}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.text();
        })
        .then((data) => {
          parseICS(data);
        })
        .catch((error) => {
          console.error("Hubo un problema con la carga del archivo .ics:", error);
        });
    }

    function parseICS(data) {
      const events = [];
      const lines = data.split(/\r?\n/);
      let currentEvent = null;
      let previousKey = null;

      lines.forEach((line) => {
        if (line.startsWith(" ") && currentEvent && previousKey) {
          currentEvent[previousKey] += line.trim();
        } else if (line.startsWith("BEGIN:VEVENT")) {
          currentEvent = {};
        } else if (line.startsWith("END:VEVENT")) {
          if (currentEvent && currentEvent["DTSTART"] && currentEvent["DTEND"]) {
            // Verificaci칩n de fechas v치lidas para eventos de todo el d칤a
            if (currentEvent["X-MICROSOFT-CDO-ALLDAYEVENT"] === "TRUE") {
              if (!isValidDate(currentEvent["DTSTART"], true) || !isValidDate(currentEvent["DTEND"], true)) {
              } else {
                currentEvent["TODO_EL_DIA"] = "TODO EL D칈A";
                events.push(currentEvent);  // Agregar el evento de todo el d칤a
              }
            } else {
              // Verificaci칩n para eventos no todo el d칤a
              if (!isValidDate(currentEvent["DTSTART"]) || !isValidDate(currentEvent["DTEND"])) {
                console.error("Evento con fecha no v치lida:", currentEvent);
              } else {
                if (currentEvent["RRULE"]) {
                  const recurrenceEvents = generateRecurrenceEvents(currentEvent);
                  events.push(...recurrenceEvents);
                } else {
                  events.push(currentEvent);
                }
              }
            }
          } else {
            console.error("Evento incompleto, falta DTSTART o DTEND:", currentEvent);
          }
          currentEvent = null;
        } else if (currentEvent) {
          const [key, value] = line.split(":");

          // Procesar claves que contienen par치metros, como DTSTART;VALUE=DATE
          if (key.includes(";")) {
            const keyParts = key.split(";");
            const mainKey = keyParts[0];  // Ejemplo: "DTSTART"
            const parameter = keyParts[1];  // Ejemplo: "VALUE=DATE"

            // Agregar par치metros al valor de la fecha
            if (mainKey === "DTSTART" || mainKey === "DTEND") {
              currentEvent[mainKey] = value; // Asignamos el valor de la fecha
              currentEvent[`${mainKey}_PARAM`] = parameter; // Guardamos el par치metro adicional
            }
          } else if (key.startsWith("DTSTART") || key.startsWith("DTEND")) {
            // Procesamos la fecha y hora de inicio y fin
            if (key.includes("VALUE=DATE")) {
              currentEvent[key] = value; // Asignamos la fecha (sin hora)
            } else {
              // Si tiene zona horaria, lo procesamos con la zona horaria
              currentEvent[key] = value;
            }
            previousKey = key;
          } else {
            currentEvent[key] = value;
            previousKey = key;
          }
        }
      });

      displayEvents(events);
    }

    // Funci칩n para validar fechas
    function isValidDate(date, isAllDayEvent = false) {
      const regex = isAllDayEvent ? /^\d{8}$/ : /^\d{8}T\d{6}(Z|([+-]\d{4}))?$/; // Formato: 20231205 o 20231205T140000Z
      return regex.test(date);
    }


    function generateRecurrenceEvents(event) {
      const recurrenceEvents = [];
      const rrule = event["RRULE"];
      const startDate = formatICSDate(event["DTSTART"]);
      const endDate = formatICSDate(event["DTEND"]);

      const ruleParts = rrule.split(";");
      let frequency = "DAILY",
        interval = 1,
        untilDate = null,
        byDays = [];

      ruleParts.forEach((part) => {
        const [key, value] = part.split("=");
        if (key === "FREQ") frequency = value;
        if (key === "UNTIL") untilDate = formatICSDate(value);
        if (key === "INTERVAL") interval = parseInt(value);
        if (key === "BYDAY") byDays = value.split(",");
      });

      const daysMap = { SU: 0, MO: 1, TU: 2, WE: 3, TH: 4, FR: 5, SA: 6 };
      const startDay = new Date(startDate).getDay();

      let currentDate = new Date(startDate);
      const until = untilDate ? new Date(untilDate) : new Date(currentDate.getFullYear() + 1, 0, 1);

      while (currentDate <= until) {
        byDays.forEach((day) => {
          const dayOfWeek = daysMap[day];
          const eventDate = new Date(currentDate);
          eventDate.setDate(currentDate.getDate() + ((dayOfWeek - startDay + 7) % 7));

          if (eventDate <= until && eventDate >= currentDate) {
            const newEvent = {
              DTSTART: eventDate.toISOString(),
              DTEND: new Date(eventDate.getTime() + (endDate - startDate)).toISOString(),
              SUMMARY: event["SUMMARY"],
              LOCATION: event["LOCATION"],
              DESCRIPTION: event["DESCRIPTION"],
            };
            recurrenceEvents.push(newEvent);
          }
        });
        currentDate.setDate(currentDate.getDate() + 7 * interval);
      }

      return recurrenceEvents;
    }

    function displayEvents(events) {
      calendar.removeAllEvents();
      events.forEach((event) => {
        const description = event["SUMMARY"] || "Sin descripci칩n";
        const location = event["LOCATION"] || "Sin ubicaci칩n";
        const requerimientos = event["DESCRIPTION"] ? cleanRequerimientos(event["DESCRIPTION"]) : "Sin requerimientos";
        const busyStatus = event["X-MICROSOFT-CDO-BUSYSTATUS"] || "BUSY";
        const classNames = busyStatus === "TENTATIVE" ? "tentative" : "busy";

        // Validaci칩n para eventos de todo el d칤a (sin horas especificadas en DTSTART/DTEND)
        let eventStart = formatICSDate(event["DTSTART"], event["X-MICROSOFT-CDO-ALLDAYEVENT"] === "TRUE");
        let eventEnd = formatICSDate(event["DTEND"], event["X-MICROSOFT-CDO-ALLDAYEVENT"] === "TRUE");

        // Para eventos de todo el d칤a, no asignamos horas
        if (event["X-MICROSOFT-CDO-ALLDAYEVENT"] === "TRUE") {
          // Aseg칰rate de que la fecha se mantenga sin horas
          eventStart = eventStart.split("T")[0];  // Solo la fecha, sin hora
          eventEnd = eventEnd.split("T")[0];      // Solo la fecha, sin hora
        }

        // Si la fecha y la hora son correctas, agregar al calendario
        if (eventStart && eventEnd) {
          calendar.addEvent({
            title: description,
            start: eventStart,
            end: eventEnd,
            extendedProps: {
              description: description,
              location: location,
              requerimientos: requerimientos,
            },
            classNames: [classNames],
          });
        }
      });
    }

    function cleanRequerimientos(description) {
      // Limpiar el campo de requerimientos, si es necesario
      const regex = /Requerimientos:\s*(.*)/;
      const match = description.match(regex);
      return match ? match[1] : "Sin requerimientos";
    }

    function formatICSDate(icsDate, isAllDay = false) {
      if (!icsDate) return "";

      // Si el evento es de todo el d칤a, solo devolvemos la fecha en formato YYYY-MM-DD con hora 00:00
      if (isAllDay) {
        return icsDate.replace("T", "TODO EL DIA");  // Asignamos la hora 08:30 para los eventos de todo el d칤a
      }

      return icsDate.replace("T", " ");  // Si tiene hora, simplemente reemplazamos "T" por un espacio
    }

  </script>
</body>

</html>