<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.2/main.min.css" rel="stylesheet" />
  <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/web-component@6.1.15/index.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js'></script>
  <style>
    .fc-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fc-toolbar-title {
      font-size: 18px;
      margin-left: 20px;
    }

    #textCampo {
      margin-left: 20px;
      margin-right: 10px;
    }

    h1,
    h2,
    h3 {
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      color: #333;
    }

    select {
      width: auto;
      padding: 5px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-left: 10px;
    }

    #calendar {
      height: calc(100vh - 100px);
    }
    #reservationButton {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        transition: background-color 0.3s;
        margin-left: 140px;
        margin-top: 15px;
      }

      #reservationButton:hover {
        background-color: #0056b3;
      }

    /* Estilos para hacer que el calendario ocupe toda la altura en mÃ³viles */
    @media (max-width: 768px) {
      #calendar {
        height: 100vh;
      }

      #reservationButton {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        transition: background-color 0.3s;
        margin-left: 140px;
        margin-top: 15px;
      }

      #reservationButton:hover {
        background-color: #0056b3;
      }
    }

    .fc-footer {
      margin-top: 0;
      /* Elimina el margen superior */
    }

    .fc-event {
      padding: 5px;
      border-radius: 5px;
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
      position: relative;
      overflow: hidden;
    }

    .fc-event::before {
      content: '';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background-color: #2196F3;
      border-radius: 50%;
    }

    .fc-event-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>

</head>

<body>
  <div id="calendar"></div>

  <script src="ics-parser.js"></script>
  <script>
    let calendar;

    const icsUrls = {
      "FHGCP DECANATO SALA CONSEJO FACULTAD ðŸ‘¤25": "http://outlook.office365.com/owa/calendar/f03c42313f964c819b4aecd10a62f81f@uc.cl/46e74d9c80a945e384f3971b525ea76e11052745610678742020/calendar.ics",
      "FHGCP DECANATO SALA REUNIONES ðŸ‘¤10": "http://outlook.office365.com/owa/calendar/0d1da151aef7420190fb315b6d4dfadc@uc.cl/7317cf9f67ea4dd8b91c5daa82d595867171139558961955839/calendar.ics",
      "FHGCP SALA USOS MULTIPLES ðŸ‘¤22": "http://outlook.office365.com/owa/calendar/00a05e5068504048b8219caa353bb694@uc.cl/e30ae1041cf641ae91784c7b661367306773761822066238338/calendar.ics",
      "FHGCP DECANATO AUDITORIO ðŸ‘¤126": "http://outlook.office365.com/owa/calendar/e857cbdab6ea47749bc06e0adc9dbb73@uc.cl/05c7b41e95694645bfda2c3b084ade8014595092356990759330/calendar.ics",
      "FHGCP A 7 ðŸ‘¤10": "http://outlook.office365.com/owa/calendar/c2a170fe59e5429cbaae8abf19d63f1f@uc.cl/4f4848a287944d0d95a8fe98bddc868e14502745448413807140/calendar.ics",
      "FHGCP SEMINARIO FACULTAD ðŸ‘¤41": "http://outlook.office365.com/owa/calendar/cb9d40caf77c43629fdb9f7cb9249afb@uc.cl/2f99deb939944c9a9de027ccc2e821497528731868425315838/calendar.ics",
      "FHGCP SEMINARIO 1 ðŸ‘¤20": "http://outlook.office365.com/owa/calendar/f629bb8381d74e0d983c7b3a7046bd9d@uc.cl/7c7ff6bd15b145feb486c1038123e85b9030138489073154610/calendar.ics",
      "FHGCP SEMINARIO 3 ðŸ‘¤20": "http://outlook.office365.com/owa/calendar/784fbbe196e6488fa3ccf1188110b51d@uc.cl/843b2e2da6bd44a3bf3ebaa4fc1261378700988533943244368/calendar.ics",
      "FHGCP SEMINARIO 4 ðŸ‘¤14": "http://outlook.office365.com/owa/calendar/36640d39764643ec9478ecabeaf12fac@uc.cl/60ef724d838749ebbd1508696831d3e03505045718671364020/calendar.ics",
      "FHGCP SEMINARIO 5 ðŸ‘¤14": "http://outlook.office365.com/owa/calendar/fb1053ad62dc4080a7dae63e4e611066@uc.cl/bc7ee4f56c4d4f269b9ec65fa5f4a57a15500861614651285450/calendar.ics",
      "FHGCP SEMINARIO 6 ðŸ‘¤10": "http://outlook.office365.com/owa/calendar/09429815e1a34cc0bb43e98250bbf0c6@uc.cl/907f486c650149fa91869781aadefaeb4501534105365124751/calendar.ics",
      "FHGCP HUMANIDADES 1 ðŸ‘¤4": "http://outlook.office365.com/owa/calendar/235b2e37013147b0999557e26748d96b@uc.cl/c8e962a0d7d4479d81ae6fa110f8f65a16714046150349654577/calendar.ics",
      "FHGCP HUMANIDADES 2 ðŸ‘¤4": "http://outlook.office365.com/owa/calendar/598fea8e95f543ba8b521b49fc384ba2@uc.cl/4ca8de726ca9473190872a6735eb84a616695268912745945723/calendar.ics",
      "FHGCP HUMANIDADES 3 ðŸ‘¤4": "http://outlook.office365.com/owa/calendar/854f687d101745b481c3892f5ff6f2d1@uc.cl/38f78a1f13d1434e8eb91d645dd4547810658958581129542550/calendar.ics",
      "FHGCP HUMANIDADES 4 ðŸ‘¤4": "http://outlook.office365.com/owa/calendar/bc6e41c921704d3293d6ddcc403062cc@uc.cl/64b37ec71d7148859fc10832f63b219c1386908969546599371/calendar.ics",
      "FHGCP SALA CONSEJO HISTORIA ðŸ‘¤12": "http://outlook.office365.com/owa/calendar/ec65ead6c8564a17ac3ea480542fe5fa@uc.cl/0318f94758864b32a68ac0567319535b8003472245692917270/calendar.ics",
      "FHGCP B1": "http://outlook.office365.com/owa/calendar/1570bd351a0f4641a51f5762eb4ecfcb@uc.cl/a25a19363e2e474a9047f2fb8018ba0411043444115954974137/calendar.ics",
      "FHGCP SALA DE CONSEJO INSTITUTO DE GEOGRAFIA ðŸ‘¤8": "http://outlook.office365.com/owa/calendar/4b0b3a0a1fc6489b87524b9b7ed9c687@uc.cl/8d66e4c06f5e4b4692af362963a98da03628685577008031525/calendar.ics",
      "FHGCP TERRAZA ðŸ‘¤50": "http://outlook.office365.com/owa/calendar/3033c0791e414b4fa60cc29a059e4037@uc.cl/988ff7fb55c14d42b29b01c0860b7c0e3542970083574507192/calendar.ics",
      "FHGCP DOCTORADO GEOGRAFIA ðŸ‘¤10": "http://outlook.office365.com/owa/calendar/0253785e99494b18859b3cd9020aa93a@uc.cl/643ef88f85324b359beb359e913e26c66644004865990384362/calendar.ics",
      "FHGCP SALA ATACAMA (BLOQUEADA)": "http://outlook.office365.com/owa/calendar/b5117cef0ec94991a099c3561b707736@uc.cl/1db1373dffb64e47a946c80071e8e38d5796220034483856327/calendar.ics",
      "FHGCP SALA PATAGONIA (BLOQUEADA)": "http://outlook.office365.com/owa/calendar/b32f2d9add9849fdb80f435fccfda899@uc.cl/ab223c3d83b7461fa7ad0da90adb50771180359976278031607/calendar.ics",
      "FHGCP LABORATORIO DE GEOMATICA ðŸ‘¤14": "http://outlook.office365.com/owa/calendar/046148a2e92a42f9a6b2d31973ec711f@uc.cl/b8812806946548e79cc1ccdda6926e3c9063704853347367516/calendar.ics",
      "FHGCP SALA DE CONSEJO INSTITUTO DE HISTORIA ðŸ‘¤12": "http://outlook.office365.com/owa/calendar/773017c378cd4f11b8989213c2bc4de1@uc.cl/fb818c8c339a4b20ad4ead0dd1f4b1ad11313192983062406126/calendar.ics",
      "FHGCP LABORATORIO HISTORIA DIGITAL (BLOQUEADA)": "http://outlook.office365.com/owa/calendar/0f52822f5d1443ca9da46abe398d3cad@uc.cl/bd3e7f72cc844f38a9cc0d517cd0660616195049527368204434/calendar.ics",
      "FHGCP SALA SEMINARIO HISTORIA": "http://outlook.office365.com/owa/calendar/266599e201af412ea7dae37017d005d9@uc.cl/192bfa5db8de4aa2ac7349d5f0c8b18715751757247432996149/calendar.ics",
      "FHGCP SALA DE CONSEJO INSTITUTO CIENCIA POLITICA ðŸ‘¤12": "http://outlook.office365.com/owa/calendar/4bd6e6a4752445929d0b62430fa599a0@uc.cl/f9c7109bea984bf1979b1e714b5ea0585302724608420494240/calendar.ics",
      "FHGCP DOCTORADO ICP ðŸ‘¤12": "http://outlook.office365.com/owa/calendar/22c286212fae46b994a3ce3a8de2065c@uc.cl/a5bcf5a0d1a44f138c0ebcf10e01b75d5615022796294095401/calendar.ics",
      "FHGCP SIMULACION ICP (BLOQUEADA)": "http://outlook.office365.com/owa/calendar/d3613bdc983349eb8d23977a35f0cd9a@uc.cl/2dd4884b46184544a0c20b85bc0f741f10623902703247629494/calendar.ics"
    };

    const reservationLinks = {
      "FHGCP_A_7": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-A-7@uc.cl&location=FHGCP-A-7@uc.cl",
      "FHGCP_DECANATO_AUDITORIO": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DECANATO-AUDITORIO@uc.cl&location=FHGCP-DECANATO-AUDITORIO@uc.cl",
      "FHGCP_DECANATO_SALA_CONSEJO_FACULTAD": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DECANATO-SALA-CONSEJO-FACULTAD@uc.cl&location=FHGCP-DECANATO-SALA-CONSEJO-FACULTAD@uc.cl",
      "FHGCP_DECANATO_SALA_REUNIONES": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DECANATO-SALA-REUNIONES@uc.cl&location=FHGCP-DECANATO-SALA-REUNIONES@uc.cl",
      "FHGCP_DOCTORADO_GEOGRAFIA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DOCTORADO-GEOGRAFIA@uc.cl&location=FHGCP-DOCTORADO-GEOGRAFIA@uc.cl",
      "FHGCP_DOCTORADO_ICP": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DOCTORADO-ICP@uc.cl&location=FHGCP-DOCTORADO-ICP@uc.cl",
      "FHGCP_DOCTORADO_ICP_2": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-DOCTORADO-ICP-2@uc.cl&location=FHGCP-DOCTORADO-ICP-2@uc.cl",
      "FHGCP_HUMANIDADES_1": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-1@uc.cl&location=FHGCP-HUMANIDADES-1@uc.cl",
      "FHGCP_HUMANIDADES_2": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-2@uc.cl&location=FHGCP-HUMANIDADES-2@uc.cl",
      "FHGCP_HUMANIDADES_3": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-3@uc.cl&location=FHGCP-HUMANIDADES-3@uc.cl",
      "FHGCP_HUMANIDADES_4": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-HUMANIDADES-4@uc.cl&location=FHGCP-HUMANIDADES-4@uc.cl",
      "FHGCP_LABORATORIO_DE_GEOMATICA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-LABORATORIO-DE-GEOMATICA@uc.cl&location=FHGCP-LABORATORIO-DE-GEOMATICA@uc.cl",
      "FHGCP_LABORATORIO_HISTORIA_DIGITAL": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-LABORATORIO-HISTORIA-DIGITAL@uc.cl&location=FHGCP-LABORATORIO-HISTORIA-DIGITAL@uc.cl",
      "FHGCP_SALA_ATACAMA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-ATACAMA@uc.cl&location=FHGCP-SALA-ATACAMA@uc.cl",
      "FHGCP_SALA_CONSEJO_HISTORIA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-CONSEJO-HISTORIA@uc.cl&location=FHGCP-SALA-CONSEJO-HISTORIA@uc.cl",
      "FHGCP_SALA_CONSEJO_ICP": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-DE-CONSEJO-INSTITUTO-CIENCIA-POLITICA@uc.cl&location=FHGCP-SALA-DE-CONSEJO-INSTITUTO-CIENCIA-POLITICA@uc.cl",
      "FHGCP_SALA_DE_CONSEJO_INSTITUTO_DE_GEOGRAFIA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-DE-CONSEJO-INSTITUTO-DE-GEOGRAFIA@uc.cl&location=FHGCP-SALA-DE-CONSEJO-INSTITUTO-DE-GEOGRAFIA@uc.cl",
      "FHGCP_SALA_PATAGONIA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-PATAGONIA@uc.cl&location=FHGCP-SALA-PATAGONIA@uc.cl",
      "FHGCP_SALA_SEMINARIO_HISTORIA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-SEMINARIO-HISTORIA@uc.cl&location=FHGCP-SALA-SEMINARIO-HISTORIA@uc.cl",
      "FHGCP_SALA_USOS_MULTIPLES": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SALA-USOS-MULTIPLES@uc.cl&location=FHGCP-SALA-USOS-MULTIPLES@uc.cl",
      "FHGCP_SEMINARIO_1": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-1@uc.cl&location=FHGCP-SEMINARIO-1@uc.cl",
      "FHGCP_SEMINARIO_3": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-3@uc.cl&location=FHGCP-SEMINARIO-3@uc.cl",
      "FHGCP_SEMINARIO_4": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-4@uc.cl&location=FHGCP-SEMINARIO-4@uc.cl",
      "FHGCP_SEMINARIO_5": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-5@uc.cl&location=FHGCP-SEMINARIO-5@uc.cl",
      "FHGCP_SEMINARIO_6": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-6@uc.cl&location=FHGCP-SEMINARIO-6@uc.cl",
      "FHGCP_SEMINARIO_FACULTAD": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SEMINARIO-FACULTAD@uc.cl&location=FHGCP-SEMINARIO-FACULTAD@uc.cl",
      "FHGCP_SIMULACION_ICP": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-SIMULACION-ICP@uc.cl&location=FHGCP-SIMULACION-ICP@uc.cl",
      "FHGCP_TERRAZA": "https://outlook.office.com/calendar/0/deeplink/compose?to=FHGCP-TERRAZA@uc.cl&location=FHGCP-TERRAZA@uc.cl",
    };
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');

      function isMobileDevice() {
        return /Mobi|Android/i.test(navigator.userAgent);
      }

      let headerToolbar, footerToolbar;

      if (isMobileDevice()) {
        headerToolbar = {
          left: 'dayGridMonth,dayGridWeek,dayGridDay',
          center: '',
          right: ''
        };
        footerToolbar = {
          left: 'title',
          center: 'prev,today,next',
          right: ''
        };
      } else {
        headerToolbar = {
          left: 'dayGridMonth,dayGridWeek,dayGridDay',
          center: 'title,prev,today,next',
          right: ''
        };
        footerToolbar = {
          left: '',
          center: '',
          right: ''
        };
      }

      calendar = new FullCalendar.Calendar(calendarEl, {
        firstDay: 1,
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: headerToolbar,
        footerToolbar: footerToolbar,
        buttonText: {
          today: 'Hoy',
          month: 'Mes',
          week: 'Sem',
          day: 'DÃ­a'
        },
        eventContent: function (arg) {
          const date = arg.event.start;
          const dateEnd = arg.event.end;
          const formattedTime = date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });
          const formattedTimeEnd = dateEnd.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });

          return {
            html: `<br>${formattedTime} - ${formattedTimeEnd}<br>${arg.event.title}`
          };
        }
      });

      calendar.render();

      const toolbar = document.querySelector('.fc-toolbar-chunk:nth-child(3)');

      const select = document.createElement('select');
      select.id = 'calendarSelector';
      const texto = document.createElement('span');
      texto.id = 'textCampo';
      texto.textContent = 'Sala:';

      const reservationButton = document.createElement('button');
      reservationButton.id = 'reservationButton';
      reservationButton.textContent = 'RESERVA';
      reservationButton.onclick = function () {
        const selectedCalendar = select.value;
        // Reemplaza espacios por guiones bajos
        const formattedCalendar = selectedCalendar.replace(/ /g, '_').toUpperCase();

        if (reservationLinks[formattedCalendar]) {
          window.open(reservationLinks[formattedCalendar], '_blank');
        } else {
          console.log("No se encontrÃ³ un enlace de reserva para el calendario seleccionado.");
        }
      };

      select.addEventListener('change', function () {
        const selectedCalendar = select.value;
        if (selectedCalendar) {
          loadICS(selectedCalendar);
        }
      });

      Object.keys(icsUrls).forEach(calendarName => {
        const option = document.createElement('option');
        option.value = calendarName;
        option.textContent = calendarName.replace(/_/g, ' ');
        select.appendChild(option);
      });

      toolbar.appendChild(texto);
      toolbar.appendChild(select);
      toolbar.appendChild(reservationButton);

      loadICS(Object.keys(icsUrls)[0]);
    });

    function loadICS(roomName) {
      fetch(`/ics/${roomName}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(data => {
          parseICS(data);
        })
        .catch(error => {
          console.error('Hubo un problema con la carga del archivo .ics:', error);
        });
    }

    function parseICS(data) {
      const events = [];
      const lines = data.split(/\r?\n/);
      let currentEvent = null;

      lines.forEach(line => {
        if (line.startsWith('BEGIN:VEVENT')) {
          currentEvent = {};
        } else if (line.startsWith('END:VEVENT')) {
          if (currentEvent) {
            if (currentEvent['DTSTART'] && currentEvent['DTEND']) {
              events.push(currentEvent);
            }
          }
          currentEvent = null;
        } else if (currentEvent) {
          const [key, value] = line.split(':');
          if (key && value) {
            if (key.includes('TZID')) {
              const keyParts = key.split(';');
              currentEvent[keyParts[0]] = value;
            } else {
              currentEvent[key] = value;
            }
          }
        }
      });
      displayEvents(events);
    }

    function displayEvents(events) {
      calendar.removeAllEvents();
      events.forEach(event => {
        const start = formatICSDate(event['DTSTART']);
        const end = formatICSDate(event['DTEND']);
        const description = event['SUMMARY'] || 'Sin descripciÃ³n';
        const location = event['LOCATION'] || 'Sin ubicaciÃ³n';
        if (start && end) {
          calendar.addEvent({
            title: description,
            start: start,
            end: end,
            extendedProps: {
              location: location
            }
          });
        }
      });
    }

    function formatICSDate(dateStr) {
      const dateMatch = dateStr.match(/^(\d{8}T\d{6})(Z)?$/);
      if (!dateMatch) return null;
      const date = dateMatch[1].replace(/T/, ' ');
      return date;
    }
  </script>
</body>

</html>